<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gemini 卡路里追蹤器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 確保在載入時內容不會閃爍 */
        #app-container.hidden { display: none; }
        #loader.hidden { display: none; }
        #error-container.hidden { display: none; }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
        }
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
        }
    </style>
<link rel="stylesheet" href="/index.css">
</head>

<body class="bg-slate-50">

    <!-- 初始載入動畫 -->
    <div id="loader" class="flex justify-center items-center min-h-screen">
        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-emerald-600"></div>
    </div>

    <!-- 錯誤訊息 -->
    <div id="error-container" class="hidden min-h-screen flex items-center justify-center p-4">
         <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg shadow-md relative max-w-lg w-full" role="alert">
            <strong class="font-bold">發生錯誤！</strong>
            <span class="block sm:inline" id="error-message">應用程式無法載入。</span>
            <p class="text-sm mt-2">請檢查您的網路連線，或確認 Gemini API 金鑰是否已正確設定在 index.html 檔案中。</p>
        </div>
    </div>

    <!-- 主應用程式容器 -->
    <div id="app-container" class="hidden font-sans text-slate-800">
        <!-- 應用程式內容將由 JavaScript 動態插入 -->
    </div>

    <!-- HTML 模板 -->
    <template id="app-template">
        <div class="min-h-screen bg-slate-50">
            <header class="bg-white shadow-md sticky top-0 z-10">
                <nav class="container mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center py-3">
                    <h1 class="text-xl sm:text-2xl font-bold text-emerald-600">Gemini 卡路里追蹤器</h1>
                    <div id="nav-buttons" class="flex items-center space-x-2 sm:space-x-4">
                        <button data-view="log" class="nav-button flex items-center space-x-2 px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                            <span class="hidden sm:inline">餐點記錄</span>
                        </button>
                        <button data-view="profile" class="nav-button flex items-center space-x-2 px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                            <span class="hidden sm:inline">個人檔案</span>
                        </button>
                    </div>
                </nav>
            </header>

            <main class="container mx-auto p-4 sm:p-6 lg:p-8">
                <!-- 視圖內容 -->
                <div id="log-view-container"></div>
                <div id="profile-view-container"></div>
            </main>
        </div>
    </template>

    <template id="profile-form-template">
        <!-- ... 內容 ... -->
    </template>
    
    <!-- ...其他模板... -->

    <script type="module">
        // -----------------------------------------------------------------------------
        // ** 重要 **：請在此處填入您的 Gemini API 金鑰
        // 您可以從 Google AI Studio 取得金鑰：https://aistudio.google.com/app/apikey
        // -----------------------------------------------------------------------------
        const API_KEY = "AIzaSyBHFJpoRvnyAk_4rSq-mpmv5lwzIeDl0yU";
        // -----------------------------------------------------------------------------

        import { GoogleGenAI, Type } from 'https://esm.sh/@google/genai@1.20.0';
        import Chart from 'https://esm.sh/chart.js@4.4.3/auto';

        // --- 全局變數和狀態管理 ---
        let ai;
        let weightChart = null;
        const state = {
            profile: null,
            mealLogs: [],
            view: 'log',
        };

        const dom = {
            loader: document.getElementById('loader'),
            errorContainer: document.getElementById('error-container'),
            errorMessage: document.getElementById('error-message'),
            appContainer: document.getElementById('app-container'),
        };

        // --- 核心應用程式邏輯 ---
        
        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            try {
                if (!API_KEY || API_KEY.startsWith("AIzaSy") === false) {
                    throw new Error("Gemini API 金鑰未設定或無效。請編輯 index.html 檔案並填入您的金鑰。");
                }
                ai = new GoogleGenAI({ apiKey: API_KEY });

                loadState();
                renderAppStructure();
                attachInitialEventListeners();
                renderCurrentView();

                dom.loader.classList.add('hidden');
                dom.appContainer.classList.remove('hidden');

            } catch (error) {
                console.error("應用程式初始化失敗:", error);
                dom.errorMessage.textContent = error.message || "發生未預期的錯誤。";
                dom.loader.classList.add('hidden');
                dom.errorContainer.classList.remove('hidden');
            }
        }

        function setState(newState) {
            Object.assign(state, newState);
            saveState();
            renderCurrentView();
        }

        function loadState() {
            const storedProfile = localStorage.getItem('userProfile');
            const storedLogs = localStorage.getItem('mealLogs');
            state.profile = storedProfile ? JSON.parse(storedProfile) : null;
            state.mealLogs = storedLogs ? JSON.parse(storedLogs) : [];
            state.view = state.profile ? 'log' : 'profile';
        }

        function saveState() {
            localStorage.setItem('userProfile', JSON.stringify(state.profile));
            localStorage.setItem('mealLogs', JSON.stringify(state.mealLogs));
        }

        // --- 渲染邏輯 ---
        function renderAppStructure() {
            const appTemplate = document.getElementById('app-template');
            dom.appContainer.innerHTML = '';
            dom.appContainer.appendChild(appTemplate.content.cloneNode(true));
        }

        function renderCurrentView() {
            const logViewContainer = dom.appContainer.querySelector('#log-view-container');
            const profileViewContainer = dom.appContainer.querySelector('#profile-view-container');
            
            if (!logViewContainer || !profileViewContainer) {
                setTimeout(renderCurrentView, 50);
                return;
            }

            if (!state.profile) {
                logViewContainer.innerHTML = '';
                profileViewContainer.innerHTML = '';
                renderProfileForm(profileViewContainer);
                dom.appContainer.querySelector('#nav-buttons').classList.add('hidden');
                return;
            } else {
                 dom.appContainer.querySelector('#nav-buttons')?.classList.remove('hidden');
            }

            updateNavButtons();

            if (state.view === 'log') {
                profileViewContainer.innerHTML = '';
                renderLogView(logViewContainer);
            } else {
                logViewContainer.innerHTML = '';
                renderProfileView(profileViewContainer);
            }
        }
        
        function updateNavButtons() {
            const navButtons = dom.appContainer.querySelectorAll('.nav-button');
            navButtons.forEach(button => {
                if (button.dataset.view === state.view) {
                    button.classList.add('bg-emerald-100', 'text-emerald-700');
                    button.classList.remove('text-slate-500', 'hover:bg-slate-100');
                } else {
                    button.classList.remove('bg-emerald-100', 'text-emerald-700');
                    button.classList.add('text-slate-500', 'hover:bg-slate-100');
                }
            });
        }
        
        function renderProfileForm(container, existingProfile = null) {
            const isUpdate = !!existingProfile;
            const formHtml = `
                <div class="bg-white rounded-xl shadow-md p-6 w-full h-full">
                    <h2 class="text-2xl font-bold text-center text-slate-800 mb-6">${isUpdate ? "更新個人檔案" : "歡迎！讓我們開始吧。"}</h2>
                    <form id="profile-form" class="space-y-4">
                        <div>
                          <label for="name" class="block text-sm font-medium text-slate-700">姓名</label>
                          <div class="mt-1">
                              <input id="name" name="name" type="text" required class="appearance-none block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm bg-white text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm" value="${existingProfile?.name || ''}">
                          </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="age" class="block text-sm font-medium text-slate-700">年齡</label>
                                <div class="mt-1"><input id="age" name="age" type="number" required class="appearance-none block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm bg-white text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm" value="${existingProfile?.age || 30}"></div>
                            </div>
                            <div>
                                <label for="gender" class="block text-sm font-medium text-slate-700">性別</label>
                                <select id="gender" name="gender" class="mt-1 block w-full pl-3 pr-10 py-2 bg-white border border-slate-300 rounded-md shadow-sm text-slate-900 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm">
                                    <option value="male" ${existingProfile?.gender === 'male' ? 'selected' : ''}>男性</option>
                                    <option value="female" ${existingProfile?.gender === 'female' ? 'selected' : ''}>女性</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="height" class="block text-sm font-medium text-slate-700">身高 (公分)</label>
                                <div class="mt-1"><input id="height" name="height" type="number" required class="appearance-none block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm bg-white text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm" value="${existingProfile?.height || 170}"></div>
                            </div>
                            <div>
                                <label for="weight" class="block text-sm font-medium text-slate-700">體重 (公斤)</label>
                                <div class="mt-1"><input id="weight" name="weight" type="number" step="0.1" required class="appearance-none block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm bg-white text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm" value="${existingProfile?.weight || 70}"></div>
                            </div>
                        </div>
                        <div>
                             <label for="bodyFat" class="block text-sm font-medium text-slate-700">體脂率 % (選填)</label>
                             <div class="mt-1"><input id="bodyFat" name="bodyFat" type="number" step="0.1" class="appearance-none block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm bg-white text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm" value="${existingProfile?.bodyFat || ''}"></div>
                        </div>
                        <div>
                            <label for="activityLevel" class="block text-sm font-medium text-slate-700">活動量</label>
                            <select id="activityLevel" name="activityLevel" class="mt-1 block w-full pl-3 pr-10 py-2 bg-white border border-slate-300 rounded-md shadow-sm text-slate-900 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm" value="${existingProfile?.activityLevel || 'lightlyActive'}">
                                <option value="sedentary">久坐 (幾乎不運動)</option>
                                <option value="lightlyActive" ${existingProfile?.activityLevel === 'lightlyActive' ? 'selected' : ''}>輕度活躍 (每週運動 1-3 天)</option>
                                <option value="moderatelyActive" ${existingProfile?.activityLevel === 'moderatelyActive' ? 'selected' : ''}>中度活躍 (每週運動 3-5 天)</option>
                                <option value="veryActive" ${existingProfile?.activityLevel === 'veryActive' ? 'selected' : ''}>非常活躍 (每週運動 6-7 天)</option>
                            </select>
                        </div>
                        ${isUpdate ? `
                        <div class="flex flex-col sm:flex-row gap-3 pt-2">
                             <button type="submit" name="action" value="update" class="flex-1 inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors duration-200 text-emerald-700 bg-emerald-100 hover:bg-emerald-200 focus:ring-emerald-500">更新當前資訊</button>
                             <button type="submit" name="action" value="record" class="flex-1 inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors duration-200 text-white bg-emerald-600 hover:bg-emerald-700 focus:ring-emerald-500">更新並記錄</button>
                        </div>
                        ` : `
                        <button type="submit" class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors duration-200 text-white bg-emerald-600 hover:bg-emerald-700 focus:ring-emerald-500 w-full">
                           計算我的目標
                        </button>
                        `}
                    </form>
                </div>
            `;
            container.innerHTML = formHtml;
            container.querySelector('#profile-form').addEventListener('submit', handleProfileFormSubmit);
        }

        function renderProfileView(container) {
            const dailyGoals = calculateDailyGoals(state.profile);
            const weightHistory = state.profile.weightHistory || [];
            const formattedHistory = weightHistory.map(entry => ({
                ...entry,
                date: new Date(entry.date).toLocaleDateString('zh-TW', { year: 'numeric', month: 'numeric', day: 'numeric' })
            }));

            const goalDisplayHtml = (label, value, unit) => `
                <div class="bg-gray-50 p-4 rounded-lg text-center border border-gray-200">
                    <p class="text-sm text-slate-500">${label}</p>
                    <p class="text-2xl font-bold text-emerald-600">${Math.round(value)}</p>
                    <p class="text-xs text-slate-400">${unit}</p>
                </div>`;
            
            const viewHtml = `
                <div class="space-y-6">
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <h2 class="text-2xl font-bold text-slate-800 mb-4">您的每日目標</h2>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                            ${goalDisplayHtml('卡路里', dailyGoals.tdee, 'kcal')}
                            ${goalDisplayHtml('蛋白質', dailyGoals.protein, '克')}
                            ${goalDisplayHtml('碳水化合物', dailyGoals.carbs, '克')}
                            ${goalDisplayHtml('脂肪', dailyGoals.fat, '克')}
                            ${goalDisplayHtml('纖維', dailyGoals.fiber, '克')}
                            ${goalDisplayHtml('鈉', dailyGoals.sodium, 'mg')}
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                        <div class="lg:col-span-2" id="profile-form-container"></div>
                        <div class="lg:col-span-3">
                            ${formattedHistory.length > 0 ? `
                            <div class="bg-white rounded-xl shadow-md p-6 h-full">
                                <h2 class="text-2xl font-bold text-slate-800 mb-4">體重與體脂歷史</h2>
                                <div class="relative h-[450px]"><canvas id="weight-chart"></canvas></div>
                            </div>
                            ` : `
                            <div class="bg-white rounded-xl shadow-md p-6 flex items-center justify-center h-full border-2 border-dashed border-slate-200">
                                <div class="text-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" /><path stroke-linecap="round" stroke-linejoin="round" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" /></svg>
                                    <h3 class="mt-2 text-sm font-medium text-slate-900">沒有歷史資料</h3>
                                    <p class="mt-1 text-sm text-slate-500">點擊「更新並記錄」來新增您的第一筆資料。</p>
                                </div>
                            </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML = viewHtml;
            renderProfileForm(container.querySelector('#profile-form-container'), state.profile);

            if (formattedHistory.length > 0) {
                renderWeightChart(formattedHistory);
            }
        }
        
        function renderLogView(container) {
             const dailyGoals = calculateDailyGoals(state.profile);
             const today = new Date().toISOString().split('T')[0];
             const todaysLogs = state.mealLogs.filter(log => log.date.startsWith(today));
             const dailyTotals = calculateDailyTotals(todaysLogs);

             const nutrientBarHtml = (value, goal, label, unit) => {
                const percentage = goal > 0 ? (value / goal) * 100 : 0;
                const barColor = percentage > 110 ? 'bg-red-500' : percentage > 90 ? 'bg-green-500' : 'bg-emerald-500';
                return `
                    <div>
                        <div class="flex justify-between items-baseline mb-1">
                            <span class="text-sm font-medium text-slate-700">${label}</span>
                            <span class="text-sm text-slate-500">${Math.round(value)} / ${Math.round(goal)}${unit}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="${barColor} h-2.5 rounded-full" style="width: ${Math.min(percentage, 100)}%"></div>
                        </div>
                    </div>
                `;
             };

            const viewHtml = `
                <div class="space-y-6">
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-slate-800">今日進度</h2>
                            <button id="add-meal-btn" class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors duration-200 text-white bg-emerald-600 hover:bg-emerald-700 focus:ring-emerald-500 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                                記錄餐點
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="flex flex-col items-center justify-center">
                                <div class="relative">
                                    <svg class="w-32 h-32" viewBox="0 0 36 36">
                                        <path class="text-slate-200" stroke-width="3" fill="none" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                        <path class="text-emerald-500" stroke-width="3" fill="none" stroke-dasharray="${Math.min((dailyTotals.calories / dailyGoals.tdee) * 100, 100)}, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                    </svg>
                                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                                        <span class="text-2xl font-bold text-emerald-600">${Math.round(dailyTotals.calories)}</span>
                                        <span class="text-sm text-slate-500">/ ${Math.round(dailyGoals.tdee)} kcal</span>
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-3">
                                ${nutrientBarHtml(dailyTotals.protein, dailyGoals.protein, '蛋白質', 'g')}
                                ${nutrientBarHtml(dailyTotals.carbohydrates, dailyGoals.carbs, '碳水化合物', 'g')}
                                ${nutrientBarHtml(dailyTotals.fat, dailyGoals.fat, '脂肪', 'g')}
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">餐點歷史</h2>
                        <div id="meal-history-container" class="space-y-6"></div>
                    </div>
                </div>
            `;
            container.innerHTML = viewHtml;
            renderMealHistory(container.querySelector('#meal-history-container'), dailyGoals);
            container.querySelector('#add-meal-btn').addEventListener('click', () => openMealLogModal(null));
        }
        
        function renderMealHistory(container, dailyGoals) {
            const groupedLogs = state.mealLogs.reduce((acc, log) => {
              const date = new Date(log.date).toDateString();
              if (!acc[date]) acc[date] = [];
              acc[date].push(log);
              return acc;
            }, {});

            if (Object.keys(groupedLogs).length === 0) {
                container.innerHTML = `<p class="text-center text-slate-500 py-4">尚未記錄任何餐點。點擊「記錄餐點」開始！</p>`;
                return;
            }
            
            const getNutrientAssessment = (value, goal, unit = 'g') => {
                if (goal === 0 || !goal) {
                    return `<td class="text-center py-3 px-2">
                        <span class="text-slate-500">-</span><br>
                        <span class="text-xs text-slate-500">${Math.round(value)}${unit}</span>
                    </td>`;
                }
                const percent = (value / goal) * 100;
                let assessment = {};
                if (percent < 70) assessment = { label: '過低', color: 'text-red-600' };
                else if (percent < 90) assessment = { label: '稍低', color: 'text-blue-600' };
                else if (percent <= 110) assessment = { label: '完美', color: 'text-green-600' };
                else if (percent <= 130) assessment = { label: '稍高', color: 'text-orange-500' };
                else assessment = { label: '過高', color: 'text-red-600' };
                
                return `<td class="text-center py-3 px-2">
                    <span class="${assessment.color} font-medium">${assessment.label}</span><br>
                    <span class="text-xs text-slate-500">${Math.round(value)}${unit}</span>
                </td>`;
            };

            container.innerHTML = Object.entries(groupedLogs).map(([date, logs]) => `
                <div key="${date}">
                    <div class="flex justify-between items-center mb-2 pb-2 border-b">
                        <h3 class="font-semibold text-lg">${new Date(date).toLocaleDateString('zh-TW', { dateStyle: 'full' })}</h3>
                        <button data-date="${date}" class="summary-btn inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors duration-200 text-emerald-700 bg-emerald-100 hover:bg-emerald-200 focus:ring-emerald-500">總結今日</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-500">
                            <thead class="text-xs text-slate-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="py-3 px-2">餐別</th>
                                    <th scope="col" class="py-3 px-2">描述</th>
                                    <th scope="col" class="py-3 px-2 text-center">卡路里</th>
                                    <th scope="col" class="py-3 px-2 text-center">蛋白質</th>
                                    <th scope="col" class="py-3 px-2 text-center">碳水</th>
                                    <th scope="col" class="py-3 px-2 text-center">脂肪</th>
                                    <th scope="col" class="py-3 px-2 text-center">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${logs.map(log => `
                                <tr key="${log.id}" class="bg-white border-b hover:bg-gray-50">
                                    <td class="py-3 px-2 font-medium text-slate-900 whitespace-nowrap">${log.mealType}</td>
                                    <td class="py-3 px-2">${log.description}</td>
                                    ${getNutrientAssessment(log.calories, dailyGoals.tdee / 4, 'kcal')}
                                    ${getNutrientAssessment(log.protein, dailyGoals.protein / 4, 'g')}
                                    ${getNutrientAssessment(log.carbohydrates, dailyGoals.carbs / 4, 'g')}
                                    ${getNutrientAssessment(log.fat, dailyGoals.fat / 4, 'g')}
                                    <td class="py-3 px-2 text-center">
                                        <div class="flex justify-center items-center space-x-2">
                                           <button data-log-id="${log.id}" class="edit-log-btn text-slate-500 hover:text-emerald-600 transition-colors">
                                             <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg>
                                           </button>
                                           <button data-log-id="${log.id}" class="delete-log-btn text-slate-500 hover:text-red-600 transition-colors">
                                              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                           </button>
                                        </div>
                                    </td>
                                </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `).join('');
        }

        function renderWeightChart(data) {
            const ctx = document.getElementById('weight-chart')?.getContext('2d');
            if (!ctx) return;
            if (weightChart) {
                weightChart.destroy();
            }

            const hasBodyFat = data.some(d => d.bodyFat);

            weightChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: '體重 (公斤)',
                            data: data.map(d => d.weight),
                            borderColor: '#10b981',
                            backgroundColor: '#10b98133',
                            tension: 0.1,
                            yAxisID: 'y',
                        },
                        ...(hasBodyFat ? [{
                            label: '體脂率 (%)',
                            data: data.map(d => d.bodyFat),
                            borderColor: '#8884d8',
                            backgroundColor: '#8884d833',
                            tension: 0.1,
                            yAxisID: 'y1',
                        }] : [])
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: '體重 (公斤)' }
                        },
                        y1: {
                            type: 'linear',
                            display: hasBodyFat,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                            title: { display: true, text: '體脂率 (%)' }
                        },
                    }
                }
            });
        }
        
        // --- 事件處理 ---
        function attachInitialEventListeners() {
            dom.appContainer.addEventListener('click', (e) => {
                // Navigation
                const navButton = e.target.closest('.nav-button');
                if (navButton) {
                    setState({ view: navButton.dataset.view });
                    return;
                }

                // Meal Log Actions (Event Delegation)
                const editBtn = e.target.closest('.edit-log-btn');
                if (editBtn) {
                    handleEditLogClick(editBtn.dataset.logId);
                    return;
                }

                const deleteBtn = e.target.closest('.delete-log-btn');
                if (deleteBtn) {
                    handleDeleteLogClick(deleteBtn.dataset.logId);
                    return;
                }

                const summaryBtn = e.target.closest('.summary-btn');
                if (summaryBtn) {
                    handleGenerateSummaryClick(summaryBtn.dataset.date);
                    return;
                }
            });
        }
        
        function handleProfileFormSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const isUpdate = !!state.profile;
            const action = e.submitter?.value || (isUpdate ? 'update' : 'record');

            const newProfileData = {
                name: formData.get('name'),
                age: parseFloat(formData.get('age')),
                height: parseFloat(formData.get('height')),
                weight: parseFloat(formData.get('weight')),
                gender: formData.get('gender'),
                activityLevel: formData.get('activityLevel'),
                bodyFat: parseFloat(formData.get('bodyFat')) || undefined
            };

            let updatedHistory = state.profile?.weightHistory || [];

            if (action === 'record') {
                const today = new Date().toISOString();
                const newWeightEntry = { date: today, weight: newProfileData.weight, bodyFat: newProfileData.bodyFat };
                const todayEntryIndex = updatedHistory.findIndex(entry => new Date(entry.date).toDateString() === new Date(today).toDateString());

                if (todayEntryIndex > -1) {
                    updatedHistory[todayEntryIndex] = newWeightEntry;
                } else {
                    updatedHistory.push(newWeightEntry);
                }
                updatedHistory.sort((a,b) => new Date(a.date).getTime() - new Date(b.date).getTime());
            }
            
            setState({
                profile: { ...state.profile, ...newProfileData, weightHistory: updatedHistory },
                view: isUpdate ? 'profile' : 'log'
            });
        }

        function handleEditLogClick(logId) {
            if (!logId) return;
            const logToEdit = state.mealLogs.find(log => log.id === logId);
            if (logToEdit) {
                openMealLogModal(logToEdit);
            }
        }

        function handleDeleteLogClick(logId) {
            if (!logId) return;
            openConfirmModal('您確定要刪除這筆記錄嗎？', () => {
                const updatedLogs = state.mealLogs.filter(log => log.id !== logId);
                setState({ mealLogs: updatedLogs });
            });
        }
        
        async function handleGenerateSummaryClick(date) {
            if (!date) return;
            const logsForDate = state.mealLogs.filter(log => new Date(log.date).toDateString() === date);
            if (!logsForDate || logsForDate.length === 0) return;
            
            openSummaryModal(true);
            try {
                const dailyGoals = calculateDailyGoals(state.profile);
                const result = await getDailySummary(logsForDate, dailyGoals.tdee);
                updateSummaryModalContent(result.score, result.comment);
            } catch (err) {
                updateSummaryModalContent(null, null, '無法產生總結。請再試一次。');
            }
        }

        // --- 輔助函式 ---
        function calculateDailyGoals(profile) {
            if (!profile) return { tdee: 2000, protein: 120, fat: 60, carbs: 240, sodium: 2300, fiber: 30 };
            
            const { weight, height, age, gender, activityLevel } = profile;
            const bmr = gender === 'male'
                ? 10 * weight + 6.25 * height - 5 * age + 5
                : 10 * weight + 6.25 * height - 5 * age - 161;
            
            const activityMultiplier = {
                sedentary: 1.2,
                lightlyActive: 1.375,
                moderatelyActive: 1.55,
                veryActive: 1.725,
            };
            
            const tdee = Math.round(bmr * (activityMultiplier[activityLevel] || 1.375));
            const protein = Math.round(weight * 1.6);
            const fat = Math.round((tdee * 0.25) / 9);
            const carbs = Math.round((tdee - (protein * 4) - (fat * 9)) / 4);

            return { tdee, protein, fat, carbs, sodium: 2300, fiber: 30 };
        }

        function calculateDailyTotals(logs) {
            return logs.reduce((acc, log) => {
                acc.calories += log.calories || 0;
                acc.protein += log.protein || 0;
                acc.carbohydrates += log.carbohydrates || 0;
                acc.fat += log.fat || 0;
                acc.fiber += log.fiber || 0;
                acc.sodium += log.sodium || 0;
                return acc;
            }, { calories: 0, protein: 0, carbohydrates: 0, fat: 0, fiber: 0, sodium: 0 });
        }
        
        // --- Gemini Service ---
        const nutritionSchema = {
            type: Type.OBJECT,
            properties: {
                description: { type: Type.STRING, description: "關於餐點中食物的簡短一句話總結。" },
                calories: { type: Type.NUMBER, description: "預估的總卡路里。" },
                protein: { type: Type.NUMBER, description: "預估的蛋白質克數。" },
                carbohydrates: { type: Type.NUMBER, description: "預估的碳水化合物克數。" },
                fat: { type: Type.NUMBER, description: "預估的脂肪克數。" },
                fiber: { type: Type.NUMBER, description: "預估的纖維克數。" },
                sodium: { type: Type.NUMBER, description: "預估的鈉毫克數。" },
            },
            required: ["description", "calories", "protein", "carbohydrates", "fat", "fiber", "sodium"],
        };

        const summarySchema = {
            type: Type.OBJECT,
            properties: {
                score: { type: Type.NUMBER, description: "根據目標評估當日營養的得分（1到100分）。" },
                comment: { type: Type.STRING, description: "一段簡潔、鼓勵性的評論，並附上可行的改進建議。" }
            },
            required: ["score", "comment"]
        }

        const fileToGenerativePart = async (file) => {
          const base64EncodedDataPromise = new Promise((resolve) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result.split(',')[1]);
            reader.readAsDataURL(file);
          });
          return {
            inlineData: { data: await base64EncodedDataPromise, mimeType: file.type },
          };
        };

        async function analyzeMeal(text, image) {
          try {
            const parts = [{ text: `分析這份餐點的營養成分： ${text}` }];
            if (image) {
              const imagePart = await fileToGenerativePart(image);
              parts.unshift(imagePart);
            }
            const response = await ai.models.generateContent({
              model: "gemini-2.5-flash",
              contents: { parts: parts },
              config: { responseMimeType: "application/json", responseSchema: nutritionSchema },
            });
            const jsonText = response.text.trim().replace(/^```json\s*|```\s*$/g, '');
            return JSON.parse(jsonText);
          } catch (error) {
            console.error("Error analyzing meal with Gemini:", error);
            throw new Error("分析餐點失敗。請檢查您的提示或 Gemini API 狀態。");
          }
        };

        async function getDailySummary(meals, tdee) {
            try {
                const mealDescriptions = meals.map(m => `${m.mealType}: ${m.description} (~${Math.round(m.calories)} kcal)`).join('\n');
                const prompt = `根據今天所吃的以下餐點，提供一份總結。使用者的每日卡路里目標 (TDEE) 是 ${tdee} 大卡。今天的餐點：\n${mealDescriptions}\n請提供今日的營養總結。根據他們達成目標的情況給予 1 到 100 分的評分，並附上一段簡潔、鼓勵性的評論，以及一到兩個可行的改進建議。`;
                const response = await ai.models.generateContent({
                    model: "gemini-2.5-flash",
                    contents: prompt,
                    config: { responseMimeType: "application/json", responseSchema: summarySchema },
                });
                const jsonText = response.text.trim().replace(/^```json\s*|```\s*$/g, '');
                return JSON.parse(jsonText);
            } catch (error) {
                console.error("Error generating daily summary:", error);
                throw new Error("無法產生每日總結。");
            }
        };

        // --- Modal 邏輯 ---
        
        let activeModal = null;
        function openModal(modalContentHtml) {
            if (activeModal) closeModal();
            
            const modalWrapper = document.createElement('div');
            modalWrapper.className = 'modal-wrapper';
            modalWrapper.innerHTML = `
                <div class="modal-backdrop"></div>
                ${modalContentHtml}
            `;
            
            document.body.appendChild(modalWrapper);
            activeModal = modalWrapper;
            
            activeModal.querySelector('.modal-backdrop').addEventListener('click', closeModal);
            activeModal.querySelectorAll('.modal-close-btn').forEach(btn => btn.addEventListener('click', closeModal));

            document.addEventListener('keydown', handleEscKey);
        }
        
        function closeModal() {
            if (activeModal) {
                activeModal.remove();
                activeModal = null;
            }
            document.removeEventListener('keydown', handleEscKey);
        }

        function handleEscKey(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        }

        function openConfirmModal(message, onConfirm) {
            const modalContentHtml = `
                <div id="confirm-modal" class="modal bg-white rounded-lg shadow-xl w-full max-w-sm" onclick="event.stopPropagation()">
                    <div class="p-5 text-center">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                            <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                        </div>
                        <h3 class="text-lg font-medium text-slate-900">確認刪除</h3>
                        <p class="text-sm text-slate-500 mt-2">${message}</p>
                    </div>
                    <div class="bg-slate-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-lg">
                        <button id="confirm-btn" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                            確認刪除
                        </button>
                        <button type="button" class="modal-close-btn mt-3 w-full inline-flex justify-center rounded-md border border-slate-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-slate-700 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 sm:mt-0 sm:w-auto sm:text-sm">
                            取消
                        </button>
                    </div>
                </div>
            `;
            openModal(modalContentHtml);

            activeModal.querySelector('#confirm-btn').addEventListener('click', () => {
                onConfirm();
                closeModal();
            });
        }


        // --- Meal Log Modal ---
        function openMealLogModal(existingLog) {
            const defaultMealType = () => {
                const hour = new Date().getHours();
                if (hour >= 5 && hour < 11) return '早餐';
                if (hour >= 11 && hour < 16) return '午餐';
                if (hour >= 16 && hour < 21) return '晚餐';
                return '點心';
            };

            const modalHtml = `
                <div id="meal-log-modal" class="modal bg-white rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="p-5 border-b sticky top-0 bg-white z-10">
                        <h3 class="text-lg leading-6 font-medium text-slate-900">${existingLog ? "編輯餐點記錄" : "記錄新餐點"}</h3>
                        <button class="modal-close-btn absolute top-3 right-3 text-slate-400 hover:text-slate-600 transition">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                    <div id="modal-content" class="p-5"></div>
                </div>
            `;
            openModal(modalHtml);

            const modalContentContainer = activeModal.querySelector('#modal-content');
            let imageFile = null;
            let analyzedData = existingLog ? { ...existingLog } : null;
            const mealContext = {};

            const renderInputView = () => {
                modalContentContainer.innerHTML = `
                    <form id="meal-input-form" class="space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="date" class="block text-sm font-medium text-slate-700">日期</label>
                                <input id="date" type="date" value="${new Date(existingLog?.date || Date.now()).toISOString().split('T')[0]}" class="mt-1 appearance-none block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm bg-white text-slate-900 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="mealType" class="block text-sm font-medium text-slate-700">餐別</label>
                                <select id="mealType" class="mt-1 block w-full pl-3 pr-10 py-2 bg-white border border-slate-300 rounded-md shadow-sm text-slate-900 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm">
                                    ${['早餐', '午餐', '晚餐', '點心'].map(type => `<option value="${type}" ${type === (existingLog?.mealType || defaultMealType()) ? 'selected' : ''}>${type}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div>
                          <label for="description" class="block text-sm font-medium text-slate-700">您吃了什麼？</label>
                          <textarea id="description" rows="3" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm bg-white text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm" placeholder="例如：烤雞肉沙拉佐酪梨和油醋醬">${existingLog?.description || ''}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700">或上傳一張照片</label>
                            <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-slate-300 border-dashed rounded-md">
                                <div class="space-y-1 text-center">
                                    <div id="image-preview-container">
                                        <svg class="mx-auto h-12 w-12 text-slate-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                                    </div>
                                    <div class="flex text-sm text-slate-600 justify-center">
                                        <label for="file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-emerald-600 hover:text-emerald-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-emerald-500">
                                            <span>上傳檔案</span>
                                            <input id="file-upload" name="file-upload" type="file" class="sr-only" accept="image/*">
                                        </label>
                                    </div>
                                    <p class="text-xs text-slate-500">PNG, JPG, GIF，最大 10MB</p>
                                    <div id="remove-image-btn-container"></div>
                                </div>
                            </div>
                        </div>
                        <p id="modal-error" class="text-sm text-red-600"></p>
                        <div class="flex justify-end space-x-3 pt-2">
                            <button type="button" class="modal-close-btn inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors duration-200 text-emerald-700 bg-emerald-100 hover:bg-emerald-200 focus:ring-emerald-500">取消</button>
                            <button id="analyze-btn" type="submit" class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors duration-200 text-white bg-emerald-600 hover:bg-emerald-700 focus:ring-emerald-500">分析餐點</button>
                        </div>
                    </form>
                `;
                
                activeModal.querySelector('#file-upload').addEventListener('change', handleImageChange);
                activeModal.querySelector('#meal-input-form').addEventListener('submit', handleAnalyze);
            };
            
            const renderReviewView = () => {
                const nutrientInput = (id, label, unit, value) => `
                    <div>
                        <label for="${id}" class="block text-sm font-medium text-slate-700">${label} (${unit})</label>
                        <input id="${id}" data-field="${id.split('-')[1]}" type="number" value="${Math.round(value || 0)}" class="review-input mt-1 appearance-none block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm bg-white text-slate-900 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm">
                    </div>
                `;
                modalContentContainer.innerHTML = `
                     <div class="space-y-4">
                        <h4 class="font-semibold text-lg text-slate-800">分析結果</h4>
                        <p class="text-sm text-slate-600">請檢視 AI 分析的結果。您可以直接修改以下任何欄位，然後儲存記錄。</p>
                        <div class="space-y-3">
                            <div>
                                <label for="review-description" class="block text-sm font-medium text-slate-700">描述</label>
                                <input id="review-description" data-field="description" type="text" value="${analyzedData.description}" class="review-input mt-1 appearance-none block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm bg-white text-slate-900 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm">
                            </div>
                            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                ${nutrientInput('review-calories', '卡路里', 'kcal', analyzedData.calories)}
                                ${nutrientInput('review-protein', '蛋白質', 'g', analyzedData.protein)}
                                ${nutrientInput('review-carbohydrates', '碳水', 'g', analyzedData.carbohydrates)}
                                ${nutrientInput('review-fat', '脂肪', 'g', analyzedData.fat)}
                                ${nutrientInput('review-fiber', '纖維', 'g', analyzedData.fiber)}
                                ${nutrientInput('review-sodium', '鈉', 'mg', analyzedData.sodium)}
                            </div>
                        </div>
                         <div class="flex justify-end space-x-3 pt-2">
                            <button id="re-analyze-btn" type="button" class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors duration-200 text-emerald-700 bg-emerald-100 hover:bg-emerald-200 focus:ring-emerald-500">重新分析</button>
                            <button id="save-log-btn" type="button" class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors duration-200 text-white bg-emerald-600 hover:bg-emerald-700 focus:ring-emerald-500">${existingLog ? '儲存變更' : '記錄餐點'}</button>
                        </div>
                    </div>
                `;

                activeModal.querySelector('#re-analyze-btn').addEventListener('click', renderInputView);
                activeModal.querySelector('#save-log-btn').addEventListener('click', handleSave);
                activeModal.querySelectorAll('.review-input').forEach(input => input.addEventListener('change', handleAnalyzedDataChange));
            };
            
            const handleImageChange = (e) => {
                const file = e.target.files[0];
                const errorEl = activeModal.querySelector('#modal-error');
                if (!file) return;

                if (file.size > 10 * 1024 * 1024) { // 10MB
                    errorEl.textContent = '圖片大小不能超過 10MB。';
                    return;
                }
                errorEl.textContent = '';
                imageFile = file;

                const previewContainer = activeModal.querySelector('#image-preview-container');
                previewContainer.innerHTML = `<img src="${URL.createObjectURL(file)}" alt="Meal preview" class="mx-auto h-32 w-auto rounded-md" />`;
                
                const removeBtnContainer = activeModal.querySelector('#remove-image-btn-container');
                removeBtnContainer.innerHTML = `<button type="button" id="remove-image-btn" class="text-xs text-red-500 hover:underline">移除圖片</button>`;
                removeBtnContainer.querySelector('#remove-image-btn').addEventListener('click', () => {
                    imageFile = null;
                    e.target.value = '';
                    previewContainer.innerHTML = `<svg class="mx-auto h-12 w-12 text-slate-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>`;
                    removeBtnContainer.innerHTML = '';
                });
            };

            const handleAnalyze = async (e) => {
                e.preventDefault();
                const text = activeModal.querySelector('#description').value;
                const errorEl = activeModal.querySelector('#modal-error');
                if (!text && !imageFile) {
                    errorEl.textContent = '請提供餐點的描述或圖片。';
                    return;
                }
                errorEl.textContent = '';
                
                mealContext.date = activeModal.querySelector('#date').value;
                mealContext.mealType = activeModal.querySelector('#mealType').value;

                const analyzeBtn = activeModal.querySelector('#analyze-btn');
                analyzeBtn.disabled = true;
                analyzeBtn.innerHTML = `
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    分析中...`;

                try {
                    analyzedData = await analyzeMeal(text, imageFile);
                    renderReviewView();
                } catch (err) {
                    errorEl.textContent = err.message || '發生未預期的錯誤。';
                    analyzeBtn.disabled = false;
                    analyzeBtn.innerHTML = '分析餐點';
                }
            };
            
            const handleAnalyzedDataChange = (e) => {
                const field = e.target.dataset.field;
                const value = e.target.type === 'number' ? parseFloat(e.target.value) || 0 : e.target.value;
                if (analyzedData) {
                    analyzedData[field] = value;
                }
            };

            const handleSave = () => {
                if (!analyzedData) return;
                
                const logDate = new Date(mealContext.date || existingLog.date).toISOString();
                const logMealType = mealContext.mealType || existingLog.mealType;

                const logEntry = {
                  ...analyzedData,
                  id: existingLog?.id || new Date().toISOString(),
                  date: logDate,
                  mealType: logMealType,
                };

                const newLogs = existingLog 
                    ? state.mealLogs.map(log => log.id === existingLog.id ? logEntry : log)
                    : [...state.mealLogs, logEntry];
                
                newLogs.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
                
                setState({ mealLogs: newLogs });
                closeModal();
            };

            if (existingLog) {
                renderReviewView();
            } else {
                renderInputView();
            }
        }

        function openSummaryModal(isLoading = false) {
             const modalHtml = `
                <div id="summary-modal" class="modal bg-white rounded-lg shadow-xl w-full max-w-lg relative" onclick="event.stopPropagation()">
                    <div class="p-5 border-b">
                        <h3 class="text-lg leading-6 font-medium text-slate-900">每日總結</h3>
                        <button class="modal-close-btn absolute top-3 right-3 text-slate-400 hover:text-slate-600 transition">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                    <div id="summary-content" class="p-5 min-h-[200px] flex items-center justify-center"></div>
                </div>
            `;
            openModal(modalHtml);
            if (isLoading) {
                updateSummaryModalContent();
            }
        }

        function updateSummaryModalContent(score, comment, error) {
            const contentEl = activeModal?.querySelector('#summary-content');
            if (!contentEl) return;

            if (error) {
                contentEl.innerHTML = `<p class="text-red-500">${error}</p>`;
            } else if (score !== undefined && comment !== undefined) {
                 contentEl.innerHTML = `
                    <div class="space-y-4 text-center">
                        <div>
                            <p class="text-sm text-slate-500">您的分數</p>
                            <p class="text-5xl font-bold text-emerald-600">${score}<span class="text-2xl text-slate-400">/100</span></p>
                        </div>
                        <div class="text-left">
                            <p class="font-semibold text-slate-800">AI 回饋：</p>
                            <p class="text-slate-600 whitespace-pre-wrap">${comment}</p>
                        </div>
                    </div>`;
            } else { // Loading state
                contentEl.innerHTML = `<div class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600"></div>`;
            }
        }

    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>